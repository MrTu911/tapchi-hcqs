import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

async function verify() {
  console.log('üîç KI·ªÇM TRA D·ªÆ LI·ªÜU SAU SEED\n')
  console.log('='.repeat(60))
  
  try {
    // 1. Ki·ªÉm tra Categories
    const categoryCount = await prisma.category.count()
    console.log(`\nüìö Categories: ${categoryCount}`)
    
    // 2. Ki·ªÉm tra Users
    const users = await prisma.user.groupBy({
      by: ['role'],
      _count: true
    })
    console.log(`\nüë• Users by role:`)
    users.forEach(u => console.log(`   ${u.role}: ${u._count}`))
    
    // 3. Ki·ªÉm tra Volumes & Issues
    const volumeCount = await prisma.volume.count()
    const issueCount = await prisma.issue.count()
    console.log(`\nüìñ Volumes: ${volumeCount}`)
    console.log(`üìñ Issues: ${issueCount}`)
    
    // 4. Ki·ªÉm tra Articles
    const articleCount = await prisma.article.count()
    const articles = await prisma.article.findMany({
      include: {
        submission: {
          include: {
            author: true,
            category: true
          }
        }
      }
    })
    console.log(`\nüì∞ Articles: ${articleCount}`)
    
    // Check for potential issues
    const articlesWithoutSubmission = articles.filter(a => !a.submission)
    if (articlesWithoutSubmission.length > 0) {
      console.log(`   ‚ö†Ô∏è  ${articlesWithoutSubmission.length} articles kh√¥ng c√≥ submission`)
    }
    
    const articlesWithoutAuthor = articles.filter(a => !a.submission?.author)
    if (articlesWithoutAuthor.length > 0) {
      console.log(`   ‚ö†Ô∏è  ${articlesWithoutAuthor.length} articles kh√¥ng c√≥ author`)
    }
    
    // 5. Ki·ªÉm tra Submissions
    const submissions = await prisma.submission.groupBy({
      by: ['status'],
      _count: true
    })
    console.log(`\nüìù Submissions by status:`)
    submissions.forEach(s => console.log(`   ${s.status}: ${s._count}`))
    
    // Check orphaned submissions
    const submissionsWithoutAuthor = await prisma.submission.count({
      where: { createdBy: null }
    })
    if (submissionsWithoutAuthor > 0) {
      console.log(`   ‚ö†Ô∏è  ${submissionsWithoutAuthor} submissions kh√¥ng c√≥ createdBy`)
    }
    
    // 6. Ki·ªÉm tra Reviews
    const reviewCount = await prisma.review.count()
    const reviews = await prisma.review.groupBy({
      by: ['status'],
      _count: true
    })
    console.log(`\n‚≠ê Reviews: ${reviewCount}`)
    reviews.forEach(r => console.log(`   ${r.status}: ${r._count}`))
    
    // Check reviews without reviewers
    const reviewsWithoutReviewer = await prisma.review.count({
      where: { reviewerId: null }
    })
    if (reviewsWithoutReviewer > 0) {
      console.log(`   ‚ö†Ô∏è  ${reviewsWithoutReviewer} reviews kh√¥ng c√≥ reviewer`)
    }
    
    // 7. Ki·ªÉm tra Foreign Key Integrity
    console.log(`\nüîó Foreign Key Integrity Checks:`)
    
    // Articles without valid submission
    const invalidArticles = await prisma.article.count({
      where: {
        submission: null
      }
    })
    console.log(`   Articles v·ªõi submission kh√¥ng t·ªìn t·∫°i: ${invalidArticles}`)
    
    // Submissions without valid author
    const invalidSubmissions = await prisma.submission.count({
      where: {
        author: null
      }
    })
    console.log(`   Submissions v·ªõi author kh√¥ng t·ªìn t·∫°i: ${invalidSubmissions}`)
    
    // Reviews without valid submission
    const invalidReviews = await prisma.review.count({
      where: {
        submission: null
      }
    })
    console.log(`   Reviews v·ªõi submission kh√¥ng t·ªìn t·∫°i: ${invalidReviews}`)
    
    // 8. Ki·ªÉm tra UploadedFile
    const fileCount = await prisma.uploadedFile.count()
    console.log(`\nüìé UploadedFiles: ${fileCount}`)
    
    if (fileCount === 0) {
      console.log(`   ‚ö†Ô∏è  Kh√¥ng c√≥ file n√†o ƒë∆∞·ª£c t·∫°o trong seed`)
    }
    
    // 9. Ki·ªÉm tra Audit Logs
    const auditCount = await prisma.auditLog.count()
    console.log(`\nüìã Audit Logs: ${auditCount}`)
    
    // 10. Ki·ªÉm tra Messages/Conversations
    const conversationCount = await prisma.conversation.count()
    const messageCount = await prisma.message.count()
    console.log(`\nüí¨ Conversations: ${conversationCount}`)
    console.log(`üí¨ Messages: ${messageCount}`)
    
    console.log('\n' + '='.repeat(60))
    console.log('‚úÖ VERIFICATION COMPLETE\n')
    
  } catch (error) {
    console.error('‚ùå Error during verification:', error)
  } finally {
    await prisma.$disconnect()
  }
}

verify()
