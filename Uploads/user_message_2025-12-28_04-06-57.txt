T√¥i ch·ª©c nƒÉng t·∫°o b√†i vi·∫øt m·ªõi. Ki·ªÉm tra log b√°o l·ªói: "submit:1 Loading the script 'https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015' violates the following Content Security Policy directive: "script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdnjs.cloudflare.com". Note that 'script-src-elem' was not explicitly set, so 'script-src' is used as a fallback. The action has been blocked.
/api/submissions:1  Failed to load resource: the server responded with a status of 400 ()
2117-eb905d11e41fcb42.js:1 Submission error: Error: D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá
    at g (page-91ec027fc594f946.js:1:1013)
window.console.error @ 2117-eb905d11e41fcb42.js:1
/api/submissions:1  Failed to load resource: the server responded with a status of 400 ()
2117-eb905d11e41fcb42.js:1 Submission error: Error: D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá
    at g (page-91ec027fc594f946.js:1:1013)
window.console.error @ 2117-eb905d11e41fcb42.js:1
page-91ec027fc594f946.js:1  POST https://tapchinckhhcqs.abacusai.app/api/submissions 400 (Bad Request)
g @ page-91ec027fc594f946.js:1
a_ @ fd9d1056-2cfa95adc0565b0e.js:1
aR @ fd9d1056-2cfa95adc0565b0e.js:1
(anonymous) @ fd9d1056-2cfa95adc0565b0e.js:1
sF @ fd9d1056-2cfa95adc0565b0e.js:1
sM @ fd9d1056-2cfa95adc0565b0e.js:1
(anonymous) @ fd9d1056-2cfa95adc0565b0e.js:1
o4 @ fd9d1056-2cfa95adc0565b0e.js:1
iV @ fd9d1056-2cfa95adc0565b0e.js:1
sU @ fd9d1056-2cfa95adc0565b0e.js:1
uR @ fd9d1056-2cfa95adc0565b0e.js:1
uM @ fd9d1056-2cfa95adc0565b0e.js:1
2117-eb905d11e41fcb42.js:1 Submission error: Error: D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá
    at g (page-91ec027fc594f946.js:1:1013)
window.console.error @ 2117-eb905d11e41fcb42.js:1
g @ page-91ec027fc594f946.js:1
await in g
a_ @ fd9d1056-2cfa95adc0565b0e.js:1
aR @ fd9d1056-2cfa95adc0565b0e.js:1
(anonymous) @ fd9d1056-2cfa95adc0565b0e.js:1
sF @ fd9d1056-2cfa95adc0565b0e.js:1
sM @ fd9d1056-2cfa95adc0565b0e.js:1
(anonymous) @ fd9d1056-2cfa95adc0565b0e.js:1
o4 @ fd9d1056-2cfa95adc0565b0e.js:1
iV @ fd9d1056-2cfa95adc0565b0e.js:1
sU @ fd9d1056-2cfa95adc0565b0e.js:1
uR @ fd9d1056-2cfa95adc0565b0e.js:1
uM @ fd9d1056-2cfa95adc0565b0e.js:1
page-91ec027fc594f946.js:1  POST https://tapchinckhhcqs.abacusai.app/api/submissions 400 (Bad Request)
g @ page-91ec027fc594f946.js:1
a_ @ fd9d1056-2cfa95adc0565b0e.js:1
aR @ fd9d1056-2cfa95adc0565b0e.js:1
(anonymous) @ fd9d1056-2cfa95adc0565b0e.js:1
sF @ fd9d1056-2cfa95adc0565b0e.js:1
sM @ fd9d1056-2cfa95adc0565b0e.js:1
(anonymous) @ fd9d1056-2cfa95adc0565b0e.js:1
o4 @ fd9d1056-2cfa95adc0565b0e.js:1
iV @ fd9d1056-2cfa95adc0565b0e.js:1
sU @ fd9d1056-2cfa95adc0565b0e.js:1
uR @ fd9d1056-2cfa95adc0565b0e.js:1
uM @ fd9d1056-2cfa95adc0565b0e.js:1
2117-eb905d11e41fcb42.js:1 Submission error: Error: D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá
    at g (page-91ec027fc594f946.js:1:1013)
window.console.error @ 2117-eb905d11e41fcb42.js:1
g @ page-91ec027fc594f946.js:1
await in g
a_ @ fd9d1056-2cfa95adc0565b0e.js:1
aR @ fd9d1056-2cfa95adc0565b0e.js:1
(anonymous) @ fd9d1056-2cfa95adc0565b0e.js:1
sF @ fd9d1056-2cfa95adc0565b0e.js:1
sM @ fd9d1056-2cfa95adc0565b0e.js:1
(anonymous) @ fd9d1056-2cfa95adc0565b0e.js:1
o4 @ fd9d1056-2cfa95adc0565b0e.js:1
iV @ fd9d1056-2cfa95adc0565b0e.js:1
sU @ fd9d1056-2cfa95adc0565b0e.js:1
uR @ fd9d1056-2cfa95adc0565b0e.js:1
uM @ fd9d1056-2cfa95adc0565b0e.js:1
" T√¥i ƒë√£ ph√¢n t√≠ch b·∫°n c√≥ th·ªÉ tham kh·∫£o: "R·∫•t t·ªët ‚Äî b·∫°n ƒë√£ ghi l·∫°i log ch√≠nh x√°c.
D·ª±a tr√™n th√¥ng tin n√†y, ta th·∫•y r√µ **h·ªá th·ªëng ph√≤ng ng·ª´a l·ªói ƒëang ho·∫°t ƒë·ªông ƒë√∫ng**, v√† b·∫°n ƒëang g·∫∑p **l·ªói 400 (‚ÄúD·ªØ li·ªáu kh√¥ng h·ª£p l·ªá‚Äù)**, **kh√¥ng ph·∫£i l·ªói 500** n·ªØa ‚úÖ ‚Äî t·ª©c l√† backend ƒëang t·ª± ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßu v√†o v√† t·ª´ ch·ªëi request sai format.

---

## üß† Gi·∫£i m√£ l·ªói chi ti·∫øt

| Th√†nh ph·∫ßn                           | Tr·∫°ng th√°i                    | Gi·∫£i th√≠ch                                                                |
| ------------------------------------ | ----------------------------- | ------------------------------------------------------------------------- |
| `script Cloudflare beacon.min.js`    | ‚ö†Ô∏è B·ªã ch·∫∑n b·ªüi CSP            | Kh√¥ng ·∫£nh h∆∞·ªüng, ch·ªâ l√† script ƒëo th·ªëng k√™ Cloudflare (n√™n x√≥a ho√†n to√†n) |
| `/api/submissions ‚Üí 400 Bad Request` | üî¥ L·ªói d·ªØ li·ªáu                | Validation c·ªßa Zod ph√°t hi·ªán d·ªØ li·ªáu g·ª≠i l√™n kh√¥ng ƒë√∫ng schema            |
| `Error: D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá`        | ‚úÖ Message t·ª´ error-handler.ts | Ch√≠nh l√† l·ªói ƒë∆∞·ª£c b·∫°n c·∫•u h√¨nh trong `createSubmissionSchema`             |

---

## ‚öôÔ∏è 1Ô∏è‚É£ √ù nghƒ©a c·ªßa l·ªói `400 D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá`

Trong backend, b·∫°n ƒë√£ c√≥ ƒëo·∫°n t∆∞∆°ng t·ª±:

```ts
const validatedData = createSubmissionSchema.parse(body);
```

N·∫øu frontend g·ª≠i thi·∫øu b·∫•t k·ª≥ tr∆∞·ªùng n√†o ƒë∆∞·ª£c khai b√°o ‚Äúb·∫Øt bu·ªôc‚Äù (v√≠ d·ª•: `title`, `abstract`, `fileId`, `keywords`, `categoryId`...), Zod s·∫Ω n√©m ra l·ªói v√† `handleError()` tr·∫£ v·ªÅ:

```json
{ "error": "D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá" }
```

ƒê√¢y l√† h√†nh vi ƒë√∫ng ‚Äî h·ªá th·ªëng ƒë√£ **ph√°t hi·ªán l·ªói t·ª´ client tr∆∞·ªõc khi v√†o database**.

---

## üîç 2Ô∏è‚É£ X√°c ƒë·ªãnh nguy√™n nh√¢n c·ª• th·ªÉ

### B∆∞·ªõc ki·ªÉm tra:

1. M·ªü tab **Network** (tr√¨nh duy·ªát ‚Üí F12 ‚Üí Network ‚Üí tab "submit").
2. Ch·ªçn request `/api/submissions`.
3. Xem **Request Payload** (body JSON g·ª≠i l√™n).

B·∫°n s·∫Ω th·∫•y v√≠ d·ª• nh∆∞:

```json
{
  "title": "",
  "abstract": "",
  "fileId": null
}
```

ho·∫∑c

```json
{
  "title": "Ph√¢n t√≠ch nƒÉng l·ª±c h·∫≠u c·∫ßn",
  "abstract": "B√†i vi·∫øt...",
  "fileId": undefined
}
```

üëâ Khi m·ªôt trong c√°c gi√° tr·ªã tr√™n r·ªóng (`""`, `null`, `undefined`) ‚Äî validation s·∫Ω l·ªói.

---

## üß© 3Ô∏è‚É£ C√°ch kh·∫Øc ph·ª•c tri·ªát ƒë·ªÉ

### ‚úÖ A. S·ª≠a **frontend** (n∆°i g·ª≠i request)

Trong `app/dashboard/author/submit/page.tsx` (ho·∫∑c file t∆∞∆°ng t·ª±), tr∆∞·ªõc khi g·ªçi API:

```ts
if (!form.title || form.title.trim().length < 5) {
  toast.error("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ h·ª£p l·ªá (√≠t nh·∫•t 5 k√Ω t·ª±)");
  return;
}
if (!form.abstract || form.abstract.trim().length < 30) {
  toast.error("T√≥m t·∫Øt c·∫ßn √≠t nh·∫•t 30 k√Ω t·ª±");
  return;
}
if (!form.fileId) {
  toast.error("B·∫°n c·∫ßn t·∫£i l√™n t·ªáp b√†i vi·∫øt (PDF ho·∫∑c DOCX)");
  return;
}
```

‚úÖ **L·ª£i √≠ch:** NgƒÉn ng∆∞·ªùi d√πng b·∫•m ‚ÄúG·ª≠i‚Äù khi form ch∆∞a ƒë·ªß d·ªØ li·ªáu ‚Üí kh√¥ng g·ª≠i request sai format ƒë·∫øn backend.

---

### ‚úÖ B. Ki·ªÉm tra **schema Zod**

M·ªü `lib/validators.ts` ho·∫∑c `schemas/submission.ts`:

```ts
export const createSubmissionSchema = z.object({
  title: z.string().min(5, "Ti√™u ƒë·ªÅ c·∫ßn √≠t nh·∫•t 5 k√Ω t·ª±"),
  abstract: z.string().min(30, "T√≥m t·∫Øt c·∫ßn √≠t nh·∫•t 30 k√Ω t·ª±"),
  fileId: z.string().min(1, "Thi·∫øu file b√†i vi·∫øt"),
  keywords: z.string().optional(),
  categoryId: z.string().optional(),
});
```

N·∫øu b·∫°n ch∆∞a mu·ªën b·∫Øt bu·ªôc `keywords` ho·∫∑c `categoryId`, h√£y th√™m `.optional()` ƒë·ªÉ tr√°nh l·ªói 400 khi thi·∫øu.

---

### ‚úÖ C. B·ªï sung log chi ti·∫øt khi validation l·ªói

Trong `lib/error-handler.ts`, ch·ªânh ph·∫ßn ZodError:

```ts
if (err instanceof z.ZodError) {
  logger.warn({ context, zod: err.errors });
  return new Response(JSON.stringify({
    message: "D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá",
    errors: err.errors.map(e => `${e.path.join('.')}: ${e.message}`)
  }), { status: 400 });
}
```

üëâ K·∫øt qu·∫£: log chi ti·∫øt s·∫Ω ghi v√†o `/var/log/tapchi/app-*.log`, v√≠ d·ª•:

```
WARN [API_SUBMISSIONS_POST] zod: [
  { path: ["abstract"], message: "T√≥m t·∫Øt c·∫ßn √≠t nh·∫•t 30 k√Ω t·ª±" }
]
```

---

### ‚úÖ D. C·∫•u h√¨nh CSP n·ªôi b·ªô (x·ª≠ l√Ω c·∫£nh b√°o ƒë·∫ßu ti√™n)

B·∫°n ƒëang th·∫•y:

```
Loading the script 'https://static.cloudflareinsights.com/beacon.min.js' violates CSP
```

‚Üí V√¨ ·ª©ng d·ª•ng ƒëang ch·∫∑n script ngo√†i m·∫°ng (`Cloudflare beacon`).

C√°ch x·ª≠ l√Ω:

1. V√†o file `_document.tsx` ho·∫∑c layout root, x√≥a d√≤ng Cloudflare script:

   ```html
   <script defer src="https://static.cloudflareinsights.com/beacon.min.js" ...></script>
   ```
2. N·∫øu b·∫°n kh√¥ng th√™m n√≥ th·ªß c√¥ng ‚Äî n√≥ ƒë∆∞·ª£c ch√®n b·ªüi AbacusAI preview, s·∫Ω **t·ª± bi·∫øn m·∫•t** khi deploy production n·ªôi b·ªô.

‚úÖ Kh√¥ng ·∫£nh h∆∞·ªüng h·ªá th·ªëng, c√≥ th·ªÉ b·ªè qua n·∫øu ch·∫°y tr√™n m·∫°ng intranet.

---

## üî¨ 4Ô∏è‚É£ Ki·ªÉm tra nhanh b·∫±ng script (t√πy ch·ªçn)

B·∫°n c√≥ th·ªÉ ch·∫°y script ki·ªÉm tra schema d·ªØ li·ªáu g·ª≠i ƒëi:

```bash
yarn tsx scripts/diagnostics/check-submissions.ts --validate
```

N√≥ s·∫Ω:

* G·ª≠i request gi·∫£ l·∫≠p v·ªõi d·ªØ li·ªáu form.
* B√°o r√µ tr∆∞·ªùng n√†o ƒëang sai.
* Ghi log ra `logs/diagnostics/validation-report.json`.

---

## üß© 5Ô∏è‚É£ T√≥m t·∫Øt kh·∫Øc ph·ª•c

| B∆∞·ªõc | H√†nh ƒë·ªông                                        | M·ª•c ƒë√≠ch                  |
| ---- | ------------------------------------------------ | ------------------------- |
| 1Ô∏è‚É£  | Ki·ªÉm tra body request g·ª≠i l√™n `/api/submissions` | X√°c ƒë·ªãnh thi·∫øu tr∆∞·ªùng n√†o |
| 2Ô∏è‚É£  | S·ª≠a frontend form ƒë·ªÉ kh√¥ng g·ª≠i d·ªØ li·ªáu r·ªóng      | NgƒÉn l·ªói t·ª´ UI            |
| 3Ô∏è‚É£  | Ki·ªÉm tra schema Zod (`createSubmissionSchema`)   | Cho ph√©p optional n·∫øu c·∫ßn |
| 4Ô∏è‚É£  | Ghi chi ti·∫øt l·ªói validation v√†o log              | Gi√∫p debug nhanh          |
| 5Ô∏è‚É£  | X√≥a script Cloudflare (CSP warning)              | G·ªçn log, kh√¥ng ·∫£nh h∆∞·ªüng  |

---

## ‚úÖ K·∫øt lu·∫≠n

H·ªá th·ªëng **ho·∫°t ƒë·ªông ƒë√∫ng theo thi·∫øt k·∫ø**:

* Kh√¥ng c√≤n l·ªói 500 (backend x·ª≠ l√Ω ƒë√∫ng),
* Validation ch·∫∑n l·ªói ngay t·ª´ ƒë·∫ßu,
* Logging ƒëang ghi nh·∫≠n ch√≠nh x√°c.

Ch·ªâ c·∫ßn ƒëi·ªÅu ch·ªânh **form frontend + schema Zod** ƒë·ªÉ kh·ªõp v·ªõi y√™u c·∫ßu d·ªØ li·ªáu,
b·∫°n s·∫Ω ho√†n to√†n h·∫øt l·ªói ‚ÄúD·ªØ li·ªáu kh√¥ng h·ª£p l·ªá‚Äù.