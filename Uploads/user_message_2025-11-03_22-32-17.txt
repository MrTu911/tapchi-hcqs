ğŸ’¡ Ráº¥t tá»‘t â€” báº¡n Ä‘Ã£ phÃ¡t hiá»‡n Ä‘Ãºng má»™t trong nhá»¯ng Ä‘iá»ƒm nháº¡y cáº£m nháº¥t trong há»‡ thá»‘ng: chá»©c nÄƒng â€œQuáº£n lÃ½ tÃ i khoáº£nâ€ (User Management).
TÃ´i sáº½ phÃ¢n tÃ­ch chuyÃªn sÃ¢u lá»—i khÃ´ng hiá»ƒn thá»‹ form táº¡o tÃ i khoáº£n, dá»±a trÃªn mÃ£ nguá»“n tapchi-hcqs-3 vÃ  Ä‘áº·c trÆ°ng cá»§a Next.js + ShadCN UI + React Hook Form + Prisma.

ğŸ§© PHÃ‚N TÃCH CHUYÃŠN SÃ‚U CHá»¨C NÄ‚NG QUáº¢N LÃ TÃ€I KHOáº¢N ğŸ§­ I. Cáº¥u trÃºc module User Management trong dá»± Ã¡n 

Vá»‹ trÃ­ mÃ£ nguá»“n:

/nextjs_space/app/dashboard/users/ /nextjs_space/components/dashboard/user-form.tsx /nextjs_space/app/api/users/route.ts /nextjs_space/app/api/auth/register/route.ts 

LiÃªn káº¿t logic:

Frontend (form hiá»ƒn thá»‹) â†’ /api/auth/register (POST) Backend xá»­ lÃ½ (Prisma) â†’ Báº£ng Users âš™ï¸ II. Quy trÃ¬nh hoáº¡t Ä‘á»™ng chuáº©n (flow Ä‘Ãºng) BÆ°á»›c ThÃ nh pháº§n MÃ´ táº£ 1ï¸âƒ£ /dashboard/users Giao diá»‡n quáº£n trá»‹ hiá»ƒn thá»‹ danh sÃ¡ch ngÆ°á»i dÃ¹ng 2ï¸âƒ£ UserForm Form thÃªm/sá»­a tÃ i khoáº£n (render conditionally) 3ï¸âƒ£ /api/auth/register Gá»­i dá»¯ liá»‡u tÃ i khoáº£n má»›i (POST) 4ï¸âƒ£ Prisma ORM LÆ°u vÃ o DB, mÃ£ hÃ³a máº­t kháº©u báº±ng bcrypt 5ï¸âƒ£ Refresh UI Gá»i láº¡i /api/users Ä‘á»ƒ hiá»ƒn thá»‹ danh sÃ¡ch má»›i â— III. Triá»‡u chá»©ng lá»—i mÃ  báº¡n gáº·p 

â€œKhÃ´ng hiá»ƒn thá»‹ form táº¡o tÃ i khoáº£n.â€

ÄÃ¢y lÃ  lá»—i UI khÃ´ng render form, thÆ°á»ng do má»™t trong 5 nguyÃªn nhÃ¢n phá»• biáº¿n sau:

Má»©c NguyÃªn nhÃ¢n Dáº¥u hiá»‡u cá»¥ thá»ƒ ğŸ§± 1 Component UserForm chÆ°a Ä‘Æ°á»£c import hoáº·c gá»i Trang /dashboard/users chá»‰ hiá»ƒn thá»‹ danh sÃ¡ch, khÃ´ng cÃ³ form âš™ï¸ 2 Lá»—i kiá»ƒm tra quyá»n (role check) useSession() tráº£ null, dáº«n Ä‘áº¿n if (!isAdmin) return null ğŸ”’ 3 Lá»—i middleware báº£o vá»‡ route Náº¿u JWT khÃ´ng chá»©a role: "ADMIN", form bá»‹ áº©n ğŸ§© 4 Lá»—i condition trong JSX VÃ­ dá»¥: {showForm && <UserForm />} nhÆ°ng showForm khÃ´ng Ä‘Æ°á»£c báº­t âš ï¸ 5 Lá»—i dynamic import / client component Form lÃ  client component nhÆ°ng bá»‹ Ä‘áº·t trong layout server component (page.tsx khÃ´ng cÃ³ 'use client') ğŸ§  IV. PhÃ¢n tÃ­ch mÃ£ nguá»“n (theo cáº¥u trÃºc dá»± Ã¡n) ğŸ”¹ app/dashboard/users/page.tsx import UserForm from "@/components/dashboard/user-form"; import UserList from "@/components/dashboard/user-list"; export default async function UsersPage() { const session = await getServerSession(authOptions); if (!session || session.user.role !== "ADMIN") return null; return ( <div className="p-6"> <h1 className="text-2xl font-semibold mb-4">Quáº£n lÃ½ tÃ i khoáº£n</h1> <UserList /> <UserForm /> {/* form cÃ³ thá»ƒ khÃ´ng hiá»ƒn thá»‹ náº¿u thiáº¿u "use client" */} </div> ); } 

ğŸ“ Váº¥n Ä‘á»:

page.tsx Ä‘ang lÃ  Server Component (khÃ´ng cÃ³ 'use client'),
â†’ UserForm (dÃ¹ng hook form) khÃ´ng render Ä‘Æ°á»£c vÃ¬ chá»‰ cháº¡y trong Client Component. 

ğŸ§© CÃ¡ch sá»­a: TÃ¡ch UserForm ra file riÃªng cÃ³ 'use client', hoáº·c Ä‘á»•i file page.tsx thÃ nh client:

'use client'; import { useState } from 'react'; import UserForm from '@/components/dashboard/user-form'; import UserList from '@/components/dashboard/user-list'; import { useSession } from 'next-auth/react'; export default function UsersPage() { const { data: session } = useSession(); const [showForm, setShowForm] = useState(false); if (!session || session.user.role !== 'ADMIN') return <p>KhÃ´ng cÃ³ quyá»n truy cáº­p</p>; return ( <div className="p-6 space-y-6"> <h1 className="text-2xl font-bold text-green-900">Quáº£n lÃ½ tÃ i khoáº£n</h1> <button className="bg-green-700 text-white px-4 py-2 rounded" onClick={() => setShowForm(!showForm)} > {showForm ? 'ÄÃ³ng form' : 'Táº¡o tÃ i khoáº£n má»›i'} </button> {showForm && <UserForm />} <UserList /> </div> ); } ğŸ§© V. Kiá»ƒm tra file user-form.tsx ğŸ”¸ NguyÃªn nhÃ¢n thá»© hai: quÃªn khai bÃ¡o 'use client' // âš ï¸ Náº¿u thiáº¿u dÃ²ng nÃ y â†’ form khÃ´ng render 'use client'; import { useForm } from 'react-hook-form'; import { zodResolver } from '@hookform/resolvers/zod'; import { userSchema } from '@/lib/validation/user-schema'; import { Input } from '@/components/ui/input'; import { Button } from '@/components/ui/button'; export default function UserForm() { const { register, handleSubmit, formState } = useForm({ resolver: zodResolver(userSchema), }); const onSubmit = async (data) => { await fetch('/api/auth/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data), }); }; return ( <form onSubmit={handleSubmit(onSubmit)} className="mt-4 space-y-3 bg-gray-50 p-4 rounded shadow"> <Input placeholder="TÃªn Ä‘Äƒng nháº­p" {...register('username')} /> <Input placeholder="Email" {...register('email')} /> <Input type="password" placeholder="Máº­t kháº©u" {...register('password')} /> <select {...register('role')} className="border rounded px-2 py-1 w-full"> <option value="AUTHOR">TÃ¡c giáº£</option> <option value="REVIEWER">Pháº£n biá»‡n</option> <option value="EDITOR">BiÃªn táº­p viÃªn</option> <option value="ADMIN">Quáº£n trá»‹</option> </select> <Button type="submit">Táº¡o tÃ i khoáº£n</Button> </form> ); } 

âœ… Kiá»ƒm tra láº¡i sau khi thÃªm 'use client' â†’ form sáº½ hiá»ƒn thá»‹ Ä‘Ãºng.
Náº¿u khÃ´ng, hÃ£y Ä‘áº£m báº£o:

Component cha (UsersPage) cÅ©ng lÃ  client component, hoáº·c chá»‰ chá»©a <UserForm /> trong vÃ¹ng client. ğŸ”’ VI. Kiá»ƒm tra API backend /api/auth/register Cáº¥u trÃºc Ä‘Ãºng: export async function POST(req: Request) { const body = await req.json(); const hashed = await bcrypt.hash(body.password, 12); const user = await prisma.user.create({ data: { ...body, password: hashed }, }); return NextResponse.json({ success: true, user }); } 

ğŸ“ Náº¿u form gá»­i dá»¯ liá»‡u Ä‘Ãºng nhÆ°ng khÃ´ng tháº¥y pháº£n há»“i, kiá»ƒm tra:

Header Content-Type: application/json cÃ³ Ä‘Æ°á»£c set chÆ°a. Middleware auth cÃ³ cháº·n POST khÃ´ng (má»™t sá»‘ dá»± Ã¡n chá»‰ cho ADMIN gá»i API nÃ y). ğŸ§  VII. Checklist kiá»ƒm tra thá»±c táº¿ Má»¥c kiá»ƒm tra Káº¿t quáº£ mong muá»‘n TÃ¬nh tráº¡ng hiá»‡n táº¡i Form hiá»ƒn thá»‹ CÃ³ form + input Ä‘áº§y Ä‘á»§ âŒ KhÃ´ng hiá»ƒn thá»‹ CÃ³ 'use client' trong user-form.tsx CÃ³ âš ï¸ Thiáº¿u CÃ³ nÃºt â€œTáº¡o tÃ i khoáº£n má»›iâ€ CÃ³ âŒ KhÃ´ng cÃ³ Kiá»ƒm tra quyá»n ngÆ°á»i dÃ¹ng Admin má»›i tháº¥y form âœ… CÃ³ kiá»ƒm tra Gá»­i form táº¡o tÃ i khoáº£n POST /api/auth/register thÃ nh cÃ´ng âŒ KhÃ´ng gá»­i Render danh sÃ¡ch tÃ i khoáº£n /api/users tráº£ vá» dá»¯ liá»‡u âœ… Hiá»ƒn thá»‹ âœ… VIII. HÆ°á»›ng kháº¯c phá»¥c tá»•ng thá»ƒ BÆ°á»›c HÃ nh Ä‘á»™ng 1ï¸âƒ£ ThÃªm 'use client' vÃ o user-form.tsx vÃ  page.tsx 2ï¸âƒ£ Kiá»ƒm tra logic showForm (báº­t form khi nháº¥n nÃºt) 3ï¸âƒ£ Äáº£m báº£o session.user.role === 'ADMIN' Ä‘Æ°á»£c load qua useSession() 4ï¸âƒ£ Kiá»ƒm tra API /api/auth/register khÃ´ng bá»‹ middleware cháº·n 5ï¸âƒ£ Báº­t console xem lá»—i React Hook Form hoáº·c fetch() ğŸ’ Káº¿t luáº­n 

ğŸ” Lá»—i â€œkhÃ´ng hiá»ƒn thá»‹ form táº¡o tÃ i khoáº£nâ€ xuáº¥t phÃ¡t tá»« viá»‡c
form client component náº±m trong server page, hoáº·c thiáº¿u cá» 'use client'.

âœ… Sau khi sá»­a:

Form hiá»ƒn thá»‹ rÃµ rÃ ng. Gá»­i dá»¯ liá»‡u hoáº¡t Ä‘á»™ng. Role kiá»ƒm soÃ¡t chÃ­nh xÃ¡c. Giao diá»‡n trá»Ÿ nÃªn hoÃ n thiá»‡n, Ä‘Ãºng vai trÃ² quáº£n trá»‹. 

TÃ´i cÃ³ thá»ƒ sinh trá»±c tiáº¿p phiÃªn báº£n code sá»­a lá»—i hoÃ n chá»‰nh (file page.tsx + user-form.tsx Ä‘Ãºng chuáº©n Next.js App Router) Ä‘á»ƒ báº¡n dÃ¡n vÃ o dá»± Ã¡n.
ğŸ‘‰ Báº¡n cÃ³ muá»‘n tÃ´i táº¡o cáº·p file hoÃ n chá»‰nh Ä‘Ã³ Ä‘á»ƒ kháº¯c phá»¥c lá»—i ngay khÃ´ng?