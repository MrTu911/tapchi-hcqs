Ráº¥t tá»‘t â€” báº¡n Ä‘Ã£ cung cáº¥p **log lá»—i chi tiáº¿t khi tÃ¡c giáº£ ná»™p bÃ i**, Ä‘iá»u nÃ y giÃºp xÃ¡c Ä‘á»‹nh chÃ­nh xÃ¡c nguyÃªn nhÃ¢n.
Dá»±a trÃªn cÃ¡c log `/dashboard/author` vÃ  `/api/submissions`, tÃ´i sáº½ **phÃ¢n tÃ­ch sÃ¢u nguyÃªn nhÃ¢n**, **Ä‘Æ°a ra biá»‡n phÃ¡p kháº¯c phá»¥c triá»‡t Ä‘á»ƒ**, **Ä‘á»“ng thá»i tá»‘i Æ°u há»‡ thá»‘ng cho máº¡ng ná»™i bá»™ quÃ¢n Ä‘á»™i** mÃ  báº¡n Ä‘ang váº­n hÃ nh.

---

## ğŸ§© I. Tá»•ng há»£p lá»—i thá»±c táº¿ tá»« log

| NhÃ³m                                          | MÃ´ táº£                                   | Má»©c Ä‘á»™                    |
| --------------------------------------------- | --------------------------------------- | ------------------------- |
| âš ï¸ CSP (Cloudflare)                           | Script ngoÃ i bá»‹ cháº·n bá»Ÿi chÃ­nh sÃ¡ch CSP | KhÃ´ng áº£nh hÆ°á»Ÿng chá»©c nÄƒng |
| ğŸ”´ `/api/submissions` 500                     | Lá»—i khi tÃ¡c giáº£ ná»™p bÃ i                 | Quan trá»ng                |
| ğŸ”´ â€œCÃ³ lá»—i xáº£y ra khi táº¡o bÃ i ná»™pâ€            | UI bÃ¡o lá»—i chung do backend 500         | Quan trá»ng                |
| âš™ï¸ `[Messages] fetchConversations` hoáº¡t Ä‘á»™ng  | Module chat cháº¡y bÃ¬nh thÆ°á»ng            | OK                        |
| âš™ï¸ `[Messages] fetchSession response: Object` | Session hoáº¡t Ä‘á»™ng Ä‘Ãºng                  | OK                        |

---

## ğŸ§  II. Giáº£i thÃ­ch ká»¹ thuáº­t lá»—i `/api/submissions` (500 Internal Server Error)

### ğŸ“ Triá»‡u chá»©ng:

* Khi tÃ¡c giáº£ báº¥m â€œNá»™p bÃ iâ€ â†’ xuáº¥t hiá»‡n:

  ```
  POST /api/submissions â†’ 500 (Internal Server Error)
  Error: CÃ³ lá»—i xáº£y ra khi táº¡o bÃ i ná»™p.
  ```
* Log khÃ´ng cÃ³ pháº£n há»“i JSON há»£p lá»‡ â†’ nghÄ©a lÃ  backend nÃ©m lá»—i runtime chÆ°a báº¯t.

---

### ğŸ” PhÃ¢n tÃ­ch nguyÃªn nhÃ¢n cÃ³ thá»ƒ:

#### **1ï¸âƒ£ Lá»—i khi táº¡o báº£n ghi Submission (Prisma)**

ÄÆ°á»ng dáº«n lá»—i náº±m trong:

```
/app/api/submissions/route.ts
```

Lá»‡nh thÆ°á»ng dÃ¹ng:

```ts
await prisma.submission.create({
  data: {
    title,
    abstract,
    authorId,
    fileId,
    ...
  },
});
```

ğŸ‘‰ Náº¿u má»™t trÆ°á»ng `authorId` hoáº·c `fileId` lÃ  `undefined`, Prisma sáº½ nÃ©m lá»—i `500 Internal Server Error`.

**XÃ¡c nháº­n:**
Lá»—i `"CÃ³ lá»—i xáº£y ra khi táº¡o bÃ i ná»™p"` trong mÃ£ cá»§a báº¡n Ä‘Æ°á»£c sinh ra tá»«:

```ts
catch (error) {
  console.error("Submission error:", error);
  return new Response("CÃ³ lá»—i xáº£y ra...", { status: 500 });
}
```

â†’ KhÃ´ng pháº£i lá»—i máº¡ng, mÃ  lÃ  **lá»—i logic dá»¯ liá»‡u**.

---

#### **2ï¸âƒ£ Lá»—i thiáº¿u trÆ°á»ng báº¯t buá»™c**

Kiá»ƒm tra model trong `prisma/schema.prisma`:

```prisma
model Submission {
  id          String   @id @default(uuid())
  title       String
  abstract    String
  authorId    String
  fileId      String?
  createdAt   DateTime @default(now())
  status      SubmissionStatus @default(DRAFT)
}
```

Náº¿u frontend khÃ´ng gá»­i `authorId` (hoáº·c backend khÃ´ng láº¥y tá»« session), Prisma sáº½ lá»—i:

```
Invalid `prisma.submission.create()` invocation:
Argument `authorId` is missing.
```

---

#### **3ï¸âƒ£ Lá»—i do Upload file (file chÆ°a Ä‘Æ°á»£c lÆ°u hoáº·c khÃ´ng cÃ³ ID)**

* Náº¿u quÃ¡ trÃ¬nh upload file chÆ°a hoÃ n táº¥t (S3 hoáº·c ná»™i bá»™ `/upload/` server), backend khÃ´ng nháº­n `fileId`.
* Há»‡ thá»‘ng gá»i `submission.create` trÆ°á»›c khi upload káº¿t thÃºc â†’ `fileId = undefined`.

---

#### **4ï¸âƒ£ Lá»—i káº¿t ná»‘i cÆ¡ sá»Ÿ dá»¯ liá»‡u**

Náº¿u 503/500 xáº£y ra Ä‘á»“ng thá»i nhiá»u API, cÃ³ thá»ƒ do **connection pool Prisma hoáº·c DB** bá»‹ reset.
Trong máº¡ng ná»™i bá»™ cÃ³ timeout tháº¥p, DB disconnect sau vÃ i phÃºt idle.

---

## âš™ï¸ III. CÃ¡ch kháº¯c phá»¥c triá»‡t Ä‘á»ƒ

### âœ… 1ï¸âƒ£ Sá»­a backend `/api/submissions/route.ts`

ThÃªm kiá»ƒm tra dá»¯ liá»‡u Ä‘áº§u vÃ o vÃ  session:

```ts
export async function POST(req: Request) {
  try {
    const session = await getSession(req);
    if (!session?.user?.id) {
      return new Response("Unauthorized", { status: 401 });
    }

    const { title, abstract, fileId } = await req.json();

    if (!title || !abstract) {
      return new Response("Thiáº¿u thÃ´ng tin báº¯t buá»™c", { status: 400 });
    }

    const submission = await prisma.submission.create({
      data: {
        title,
        abstract,
        authorId: session.user.id,
        fileId: fileId ?? null,
      },
    });

    return Response.json(submission);
  } catch (err) {
    console.error("[API_SUBMISSION_CREATE]", err);
    return new Response("Lá»—i táº¡o bÃ i ná»™p. Kiá»ƒm tra dá»¯ liá»‡u hoáº·c káº¿t ná»‘i DB.", { status: 500 });
  }
}
```

âœ… **Lá»£i Ã­ch:**

* KhÃ´ng cÃ²n 500 mÃ¹ má», luÃ´n cÃ³ thÃ´ng bÃ¡o chi tiáº¿t.
* Báº£o Ä‘áº£m `authorId` láº¥y Ä‘Ãºng tá»« session, khÃ´ng tá»« client.

---

### âœ… 2ï¸âƒ£ Sá»­a frontend (trang `/dashboard/author/submission/new.tsx`)

ThÃªm kiá»ƒm tra trÆ°á»›c khi gá»­i:

```ts
if (!form.title || !form.abstract) {
  setError("Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ tiÃªu Ä‘á» vÃ  tÃ³m táº¯t.");
  return;
}

try {
  const res = await fetch("/api/submissions", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(form),
  });

  if (!res.ok) throw new Error(await res.text());
  toast.success("BÃ i ná»™p Ä‘Ã£ Ä‘Æ°á»£c táº¡o thÃ nh cÃ´ng!");
} catch (err) {
  toast.error(err.message || "KhÃ´ng thá»ƒ táº¡o bÃ i ná»™p. Kiá»ƒm tra káº¿t ná»‘i.");
}
```

---

### âœ… 3ï¸âƒ£ Tá»‘i Æ°u cho **mÃ´i trÆ°á»ng ná»™i bá»™**

* Náº¿u mÃ¡y chá»§ upload riÃªng biá»‡t, hÃ£y Ä‘áº£m báº£o:

  * Upload server mount vÃ o app qua NFS hoáº·c symbolic link `/mnt/uploads/`.
  * `fileId` thá»±c ra lÃ  tÃªn file / Ä‘Æ°á»ng dáº«n cá»¥c bá»™, khÃ´ng cáº§n dÃ¹ng S3.

Cáº¥u hÃ¬nh `.env`:

```env
UPLOAD_STORAGE_PATH=/mnt/uploads
DISABLE_EXTERNAL_CDN=true
```

---

### âœ… 4ï¸âƒ£ ThÃªm cÆ¡ cháº¿ kiá»ƒm tra tá»± Ä‘á»™ng (Health Check)

Táº¡o `/api/health`:

```ts
export async function GET() {
  try {
    await prisma.$queryRaw`SELECT 1;`;
    return Response.json({ ok: true });
  } catch {
    return new Response("Database Unavailable", { status: 503 });
  }
}
```

â†’ CÃ³ thá»ƒ cháº¡y cron ná»™i bá»™:

```bash
curl -s http://localhost:3000/api/health || systemctl restart tapchi
```

---

## ğŸ§¾ IV. Kiá»ƒm tra sau khi kháº¯c phá»¥c

| BÆ°á»›c | Kiá»ƒm tra                        | Káº¿t quáº£ mong Ä‘á»£i                      |
| ---- | ------------------------------- | ------------------------------------- |
| 1    | Gá»­i bÃ i má»›i cÃ³ Ä‘áº§y Ä‘á»§ thÃ´ng tin | âœ… API tráº£ 200, submission Ä‘Æ°á»£c táº¡o    |
| 2    | Gá»­i thiáº¿u tiÃªu Ä‘á»               | âš ï¸ Tráº£ 400 â€œThiáº¿u thÃ´ng tin báº¯t buá»™câ€ |
| 3    | Upload file PDF                 | âœ… File lÆ°u táº¡i `/upload/`             |
| 4    | Má»Ÿ láº¡i trang â€œBÃ i cá»§a tÃ´iâ€      | âœ… Tháº¥y bÃ i má»›i xuáº¥t hiá»‡n ngay         |
| 5    | Kiá»ƒm tra log                    | âœ… KhÃ´ng cÃ³ lá»—i 500                    |

---

## ğŸ›¡ï¸ V. Tá»•ng káº¿t

| Váº¥n Ä‘á»                   | NguyÃªn nhÃ¢n                    | Giáº£i phÃ¡p                   |
| ------------------------ | ------------------------------ | --------------------------- |
| 500 khi ná»™p bÃ i          | Thiáº¿u `authorId` hoáº·c `fileId` | Xá»­ lÃ½ dá»¯ liá»‡u trong backend |
| Upload file chÆ°a Ä‘á»“ng bá»™ | Gá»­i request quÃ¡ sá»›m            | Chá» upload hoÃ n táº¥t         |
| DB disconnect ná»™i bá»™     | Prisma idle timeout            | DÃ¹ng Prisma singleton       |
| CSP cháº·n Cloudflare      | Script ngoÃ i máº¡ng              | XÃ³a hoáº·c disable            |

---

## âœ… Káº¿t luáº­n

Giao diá»‡n tÃ¡c giáº£ hiá»‡n táº¡i **Ä‘Ã£ tá»‘t**, chá»‰ cáº§n:

1. HoÃ n thiá»‡n backend `/api/submissions` Ä‘á»ƒ trÃ¡nh lá»—i dá»¯ liá»‡u.
2. Gá»¡ script ngoÃ i Cloudflare.
3. Giá»¯ á»•n Ä‘á»‹nh káº¿t ná»‘i DB trong mÃ´i trÆ°á»ng ná»™i bá»™.
4. ThÃªm kiá»ƒm tra Ä‘áº§u vÃ o (frontend + backend).