Ki·ªÉm tra v√† s·ª≠a l·ªói n·ªôp b√†i b√°o m·ªõi :R·∫•t t·ªët ‚Äî b·∫°n g·ª≠i log chi ti·∫øt n√™n m√¨nh c√≥ th·ªÉ x√°c ƒë·ªãnh ch√≠nh x√°c 5 l·ªói ƒë·ªôc l·∫≠p ƒëang x·∫£y ra, trong ƒë√≥ **3 l·ªói h·ªá th·ªëng (CSP, API, upstream)** v√† **2 l·ªói logic (Promise, JSON)**.
D∆∞·ªõi ƒë√¢y l√† **b·∫£n ph√¢n t√≠ch + h∆∞·ªõng kh·∫Øc ph·ª•c chi ti·∫øt nh·∫•t** (c√≥ th·ªÉ √°p d·ª•ng tr·ª±c ti·∫øp cho Next.js + Cloudflare + Prisma).

---

## üß© **1Ô∏è‚É£ L·ªói CSP ‚Äì Cloudflare beacon b·ªã ch·∫∑n**

### ‚ö†Ô∏è Log

```
Loading the script 'https://static.cloudflareinsights.com/beacon.min.js/...' 
violates Content Security Policy directive: "script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdnjs.cloudflare.com".
```

### üéØ Nguy√™n nh√¢n

Next.js ƒëang d√πng Cloudflare Analytics, nh∆∞ng ch√≠nh s√°ch CSP (`Content-Security-Policy`) c·ªßa b·∫°n ch∆∞a cho ph√©p domain ƒë√≥.

### ‚úÖ C√°ch kh·∫Øc ph·ª•c

#### ‚ú≥Ô∏è Ph∆∞∆°ng √°n A ‚Äì Gi·ªØ nguy√™n Analytics

Th√™m domain Cloudflare v√†o `next.config.js`:

```js
const securityHeaders = [
  {
    key: "Content-Security-Policy",
    value: `
      default-src 'self';
      script-src 'self' 'unsafe-inline' 'unsafe-eval'
        https://cdnjs.cloudflare.com
        https://static.cloudflareinsights.com;
      style-src 'self' 'unsafe-inline';
      img-src 'self' data: https:;
      connect-src 'self' https:;
    `.replace(/\s{2,}/g, " ").trim(),
  },
];

export default {
  async headers() {
    return [{ source: "/(.*)", headers: securityHeaders }];
  },
};
```

‚Üí ‚úÖ Sau khi deploy l·∫°i: Cloudflare Insights ho·∫°t ƒë·ªông, log CSP bi·∫øn m·∫•t.

#### ‚ú≥Ô∏è Ph∆∞∆°ng √°n B ‚Äì T·∫Øt ho√†n to√†n Analytics

N·∫øu b·∫°n kh√¥ng c·∫ßn Cloudflare Beacon:

1. V√†o Cloudflare Dashboard ‚Üí **Web Analytics**
2. Ch·ªçn domain ‚Üí T·∫Øt **‚ÄúInject Beacon Script Automatically‚Äù**
3. Deploy l·∫°i

‚Üí ‚úÖ Console s·∫°ch ho√†n to√†n, kh√¥ng b·ªã block CSP.

---

## üîå **2Ô∏è‚É£ L·ªói 503 / ERR_CONNECTION_CLOSED ‚Äì API `/api/notifications`**

### ‚ö†Ô∏è Log

```
Failed to load resource: the server responded with a status of 503 ()
Error fetching notifications: TypeError: Failed to fetch
```

### üéØ Nguy√™n nh√¢n

* Backend (API route `/api/notifications`) **b·ªã ng·∫Øt k·∫øt n·ªëi ho·∫∑c tr·∫£ v·ªÅ upstream closed**.
* C√≥ th·ªÉ do:

  * C·∫•u h√¨nh `fetch` tr·ªè sai URL trong client.
  * API handler kh√¥ng `return Response.json()` ƒë√∫ng c√°ch.
  * Cloudflare ho·∫∑c Nginx timeout.

---

### ‚úÖ C√°ch ki·ªÉm tra nhanh

1. **Ki·ªÉm tra API trong tr√¨nh duy·ªát:**
   M·ªü: `https://tapchinckhhcqs.abacusai.app/api/notifications`
   ‚Üí N·∫øu 503 ‚Üí ki·ªÉm tra server logs.

2. **Ki·ªÉm tra route handler:**

   ```ts
   // app/api/notifications/route.ts
   export async function GET(req: Request) {
     try {
       const notifications = await prisma.notification.findMany({
         orderBy: { createdAt: 'desc' },
       });
       return Response.json(notifications);
     } catch (error) {
       console.error("Notification error:", error);
       return new Response("Server error", { status: 500 });
     }
   }
   ```

3. **Th√™m timeout protection (n·∫øu g·ªçi t·ª´ client):**

   ```ts
   const res = await fetch('/api/notifications', { next: { revalidate: 10 } })
   if (!res.ok) throw new Error('Notification fetch failed')
   ```

‚Üí ‚úÖ Sau khi fix, 503 v√† ERR_CONNECTION_CLOSED s·∫Ω bi·∫øn m·∫•t.

---

## üßæ **3Ô∏è‚É£ L·ªói 500 ‚Äì `/api/submissions` (N·ªôp b√†i b√°o)**

### ‚ö†Ô∏è Log

```
/api/submissions:1  Failed to load resource: the server responded with a status of 500 ()
Error: C√≥ l·ªói x·∫£y ra khi n·ªôp b√†i
```

### üéØ Nguy√™n nh√¢n

* Server-side exception trong API n·ªôp b√†i (th∆∞·ªùng do file upload, ho·∫∑c database field thi·∫øu).
* C√°c l·ªói ph·ªï bi·∫øn:

  1. Thi·∫øu tr∆∞·ªùng `pdfUrl` ho·∫∑c `issueId` trong Prisma schema.
  2. Upload file l√™n S3/R2 l·ªói (invalid credentials).
  3. Kh√¥ng c√≥ `return Response.json()` cu·ªëi h√†m.

---

### ‚úÖ C√°ch kh·∫Øc ph·ª•c

1. **Ki·ªÉm tra `app/api/submissions/route.ts`:**

   ```ts
   export async function POST(req: Request) {
     try {
       const data = await req.json();
       const submission = await prisma.submission.create({ data });
       return Response.json(submission);
     } catch (error) {
       console.error("Submission error:", error);
       return new Response("Server error", { status: 500 });
     }
   }
   ```

2. **N·∫øu c√≥ upload file:**

   * Ki·ªÉm tra quy·ªÅn Cloudflare R2.
   * Log l·ªói chi ti·∫øt (ƒë·ª´ng ƒë·ªÉ throw silent).

3. **Ki·ªÉm tra DB schema:**

   ```prisma
   model Submission {
     id       String @id @default(uuid())
     title    String
     author   String
     pdfUrl   String?
     status   String @default("pending")
     createdAt DateTime @default(now())
   }
   ```

‚Üí ‚úÖ Khi API tr·∫£ v·ªÅ JSON ƒë√∫ng, client kh√¥ng c√≤n b√°o ‚ÄúError: C√≥ l·ªói x·∫£y ra khi n·ªôp b√†i‚Äù.

---

## ‚öôÔ∏è **4Ô∏è‚É£ L·ªói Promise & JSON parse**

### ‚ö†Ô∏è Log

```
Error fetching notifications: SyntaxError: Unexpected token 'u', "upstream c"... is not valid JSON
```

### üéØ Nguy√™n nh√¢n

API tr·∫£ v·ªÅ **chu·ªói l·ªói th√¥ (HTML ho·∫∑c text)**, nh∆∞ng client l·∫°i `.json()` n√≥.

---

### ‚úÖ C√°ch fix:

**Trong client:**

```ts
const res = await fetch('/api/notifications')
if (!res.ok) {
  const text = await res.text()
  console.error('Server response:', text)
  throw new Error('Invalid response from server')
}
const data = await res.json()
```

**Trong server API:**

```ts
return Response.json({ success: false, message: "Server error" }, { status: 500 })
```

‚Üí ‚úÖ Kh√¥ng c√≤n ‚ÄúUnexpected token u‚Äù khi parse JSON.

---

## ‚ö†Ô∏è **5Ô∏è‚É£ onBoarding.js: Uncaught (in promise) undefined**

### üéØ Nguy√™n nh√¢n

M·ªôt `Promise` b·ªã reject m√† kh√¥ng c√≥ `.catch()`
‚Üí G√¢y l·ªói ‚ÄúUncaught (in promise) undefined‚Äù.

---

### ‚úÖ C√°ch x·ª≠ l√Ω an to√†n:

```js
fetch('/api/onboarding')
  .then(r => r.json())
  .catch(err => console.error('Onboarding error:', err))
```

Ho·∫∑c v·ªõi async/await:

```ts
try {
  const res = await fetch('/api/onboarding')
  const data = await res.json()
} catch (err) {
  console.error('Onboarding error:', err)
}
```

---

# ‚úÖ **T·ªïng h·ª£p b·∫£ng l·ªói & C√°ch kh·∫Øc ph·ª•c**

| #   | L·ªói               | Nguy√™n nh√¢n                     | C√°ch x·ª≠ l√Ω                           |
| --- | ----------------- | ------------------------------- | ------------------------------------ |
| 1Ô∏è‚É£ | CSP Violation     | Cloudflare beacon b·ªã ch·∫∑n       | Th√™m domain v√†o CSP ho·∫∑c t·∫Øt beacon  |
| 2Ô∏è‚É£ | 503 Notifications | API b·ªã ƒë√≥ng k·∫øt n·ªëi / timeout   | Ki·ªÉm tra route handler & deploy logs |
| 3Ô∏è‚É£ | 500 Submissions   | L·ªói khi n·ªôp b√†i (DB/upload)     | Fix Prisma schema & API response     |
| 4Ô∏è‚É£ | JSON parse error  | API tr·∫£ v·ªÅ text thay v√¨ JSON    | S·ª≠a client & th√™m Response.json()    |
| 5Ô∏è‚É£ | Uncaught Promise  | Thi·∫øu `.catch()` ho·∫∑c try/catch | B·ªçc Promise an to√†n                  |

---

# üß† G·ª£i √Ω n√¢ng cao (s·∫°ch console & ·ªïn ƒë·ªãnh h·ªá th·ªëng)

‚úÖ Th√™m `middleware.ts` ƒë·ªÉ log l·ªói API chung:

```ts
export function middleware(req) {
  try {
    return NextResponse.next()
  } catch (e) {
    console.error('Middleware error:', e)
    return NextResponse.json({ error: 'Internal error' }, { status: 500 })
  }
}
```

‚úÖ D√πng `fetchWithTimeout` cho c√°c API client-side:

```ts
export async function fetchWithTimeout(url, ms = 8000) {
  const controller = new AbortController()
  const timeout = setTimeout(() => controller.abort(), ms)
  const res = await fetch(url, { signal: controller.signal })
  clearTimeout(timeout)
  return res
}
```

‚úÖ G·∫Øn global error handler trong `_app.tsx`:

```tsx
window.addEventListener("unhandledrejection", (e) => {
  console.error("Unhandled Promise:", e.reason)
})
```

---

N·∫øu b·∫°n mu·ªën, m√¨nh c√≥ th·ªÉ gi√∫p b·∫°n **t·∫°o file c·∫•u h√¨nh `next.config.js` + middleware.ts + error boundary chu·∫©n h√≥a to√†n h·ªá th·ªëng**, gi√∫p:

* X·ª≠ l√Ω t·∫•t c·∫£ l·ªói API 500 / 503 t·ª± ƒë·ªông
* G·ª° b·ªè to√†n b·ªô log c·∫£nh b√°o console
* TƒÉng b·∫£o m·∫≠t CSP ƒë√∫ng chu·∫©n Cloudflar
: