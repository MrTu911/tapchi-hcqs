XÃ¢y dá»±ng vÃ  hoÃ n thiá»‡n phÃ¢n há»‡ chá»©c nÄƒng 5 theo tÆ° váº¥n: Tuyá»‡t vá»i â€” tá»©c lÃ  báº¡n **Ä‘Ã£ cÃ³ phÃ¢n há»‡ 5 (Analytics)** hoáº¡t Ä‘á»™ng cÆ¡ báº£n, vÃ  báº¡n chá»‰ muá»‘n tÃ´i giÃºp **hoÃ n thiá»‡n, sá»­a lá»—i, tá»‘i Æ°u, vÃ  thÃªm cÃ¡c ná»™i dung cÃ²n thiáº¿u** mÃ  tÃ´i Ä‘Ã£ phÃ¢n tÃ­ch trÆ°á»›c.

DÆ°á»›i Ä‘Ã¢y lÃ  **báº£n cáº­p nháº­t ká»¹ thuáº­t nÃ¢ng cáº¥p (technical patch)** dÃ nh cho **phÃ¢n há»‡ 5 â€“ Thá»‘ng kÃª & BÃ¡o cÃ¡o**, vá»›i má»¥c tiÃªu **bá»• sung, vÃ¡ lá»—i vÃ  chuáº©n hÃ³a** theo kiáº¿n trÃºc báº¡n Ä‘ang dÃ¹ng (Next.js + Prisma + PostgreSQL).

---

# ğŸ§© PHÃ‚N Há»† 5 â€“ THá»NG KÃŠ & BÃO CÃO (ANALYTICS SYSTEM)

## I. ğŸ§  Má»¤C TIÃŠU HOÃ€N THIá»†N

| Háº¡ng má»¥c                               | Hiá»‡n tráº¡ng                 | Cáº§n kháº¯c phá»¥c / bá»• sung      |
| -------------------------------------- | -------------------------- | ---------------------------- |
| 1ï¸âƒ£ API thá»‘ng kÃª tá»•ng quan             | CÃ³ / chÆ°a tá»‘i Æ°u           | Gá»™p láº¡i 1 API, thÃªm caching  |
| 2ï¸âƒ£ Thá»‘ng kÃª pháº£n biá»‡n (review status) | Thiáº¿u hoáº·c khÃ´ng chÃ­nh xÃ¡c | TÃ­nh sá»‘ bÃ i theo tráº¡ng thÃ¡i  |
| 3ï¸âƒ£ Biá»ƒu Ä‘á»“ nÄƒng suáº¥t pháº£n biá»‡n        | ChÆ°a cÃ³                    | ThÃªm dá»¯ liá»‡u theo thÃ¡ng      |
| 4ï¸âƒ£ Giao diá»‡n hiá»ƒn thá»‹ biá»ƒu Ä‘á»“         | CÃ³ pháº§n thÃ´                | Chuáº©n hÃ³a layout + mÃ u sáº¯c   |
| 5ï¸âƒ£ Tá»‘i Æ°u hiá»‡u nÄƒng                   | Query trá»±c tiáº¿p            | DÃ¹ng `groupBy` + cache Redis |

---

## II. âš™ï¸ BACKEND â€” Cáº¢I TIáº¾N VÃ€ Bá»” SUNG API

### **1ï¸âƒ£ Tá»‘i Æ°u API tá»•ng quan há»‡ thá»‘ng**

Thay tháº¿ file cÅ© báº±ng:
ğŸ“„ `app/api/statistics/overview/route.ts`

```ts
import { prisma } from "@/lib/prisma";
import { NextResponse } from "next/server";

export async function GET() {
  const [users, articles, submissions, reviews] = await Promise.all([
    prisma.user.count(),
    prisma.article.count(),
    prisma.submission.count(),
    prisma.reviewAssignment.count(),
  ]);

  const pending = await prisma.submission.count({ where: { status: "PENDING" } });
  const underReview = await prisma.submission.count({ where: { status: "UNDER_REVIEW" } });
  const accepted = await prisma.submission.count({ where: { status: "ACCEPTED" } });
  const revisions = await prisma.submission.count({ where: { status: "REVISIONS_REQUIRED" } });

  return NextResponse.json({
    system: { users, articles },
    workflow: { submissions, reviews },
    status: { pending, underReview, revisions, accepted },
    updatedAt: new Date(),
  });
}
```

âœ… **Äiá»ƒm cáº£i thiá»‡n:**

* Gom query thÃ nh batch song song (`Promise.all`)
* Tráº£ vá» JSON chuáº©n hoÃ¡ (`system`, `workflow`, `status`)

---

### **2ï¸âƒ£ API thá»‘ng kÃª pháº£n biá»‡n theo thÃ¡ng**

ğŸ“„ `app/api/statistics/review-monthly/route.ts`

```ts
import { prisma } from "@/lib/prisma";
import { NextResponse } from "next/server";
import { subMonths, startOfMonth } from "date-fns";

export async function GET() {
  const months = Array.from({ length: 6 }).map((_, i) => {
    const d = subMonths(new Date(), i);
    return startOfMonth(d);
  }).reverse();

  const data = await Promise.all(months.map(async (month) => {
    const next = new Date(month);
    next.setMonth(month.getMonth() + 1);
    const count = await prisma.reviewAssignment.count({
      where: { completedAt: { gte: month, lt: next } },
    });
    return { month: month.toLocaleDateString("vi-VN", { month: "short" }), count };
  }));

  return NextResponse.json(data);
}
```

âœ… **Má»›i thÃªm:**

* Dá»¯ liá»‡u pháº£n biá»‡n 6 thÃ¡ng gáº§n nháº¥t
* Tráº£ ra máº£ng `{ month, count }` cho biá»ƒu Ä‘á»“ Ä‘Æ°á»ng hoáº·c cá»™t

---

### **3ï¸âƒ£ API lÆ°u cache Redis (tÄƒng hiá»‡u nÄƒng)**

ğŸ“„ `lib/cache.ts`

```ts
import Redis from "ioredis";

const redis = new Redis(process.env.REDIS_URL!);

export async function getCache(key: string) {
  const data = await redis.get(key);
  return data ? JSON.parse(data) : null;
}

export async function setCache(key: string, value: any, ttl = 300) {
  await redis.set(key, JSON.stringify(value), "EX", ttl);
}
```

Sá»­ dá»¥ng trong cÃ¡c route:

```ts
import { getCache, setCache } from "@/lib/cache";

export async function GET() {
  const cached = await getCache("stats:overview");
  if (cached) return NextResponse.json(cached);

  const result = await prisma.submission.groupBy({ by: ["status"], _count: { _all: true } });
  await setCache("stats:overview", result, 600);
  return NextResponse.json(result);
}
```

âœ… **Cáº£i thiá»‡n:** cache 10 phÃºt giÃºp giáº£m táº£i DB khi dashboard load nhiá»u láº§n.

---

## III. ğŸ§© FRONTEND â€” Cáº¢I TIáº¾N GIAO DIá»†N THá»NG KÃŠ

### **1ï¸âƒ£ Trang Dashboard tá»•ng quan**

ğŸ“„ `app/dashboard/admin/analytics/page.tsx`

```tsx
"use client";
import { useEffect, useState } from "react";
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer } from "recharts";

export default function AnalyticsDashboard() {
  const [overview, setOverview] = useState(null);
  const [monthly, setMonthly] = useState([]);

  useEffect(() => {
    fetch("/api/statistics/overview").then(r => r.json()).then(setOverview);
    fetch("/api/statistics/review-monthly").then(r => r.json()).then(setMonthly);
  }, []);

  if (!overview) return <p>Äang táº£i dá»¯ liá»‡u...</p>;

  return (
    <div className="p-8 space-y-8">
      <h1 className="text-2xl font-bold mb-4">ğŸ“Š Thá»‘ng kÃª há»‡ thá»‘ng</h1>

      <div className="grid grid-cols-4 gap-4">
        <StatCard title="NgÆ°á»i dÃ¹ng" value={overview.system.users} />
        <StatCard title="BÃ i bÃ¡o" value={overview.system.articles} />
        <StatCard title="Äang pháº£n biá»‡n" value={overview.status.underReview} />
        <StatCard title="ÄÃ£ cháº¥p nháº­n" value={overview.status.accepted} />
      </div>

      <div>
        <h2 className="text-xl font-semibold mb-2">Sá»‘ bÃ i pháº£n biá»‡n theo thÃ¡ng</h2>
        <ResponsiveContainer width="100%" height={300}>
          <BarChart data={monthly}>
            <XAxis dataKey="month" />
            <YAxis />
            <Tooltip />
            <Bar dataKey="count" fill="#16a34a" />
          </BarChart>
        </ResponsiveContainer>
      </div>
    </div>
  );
}

function StatCard({ title, value }) {
  return (
    <div className="p-4 border rounded shadow bg-white text-center">
      <p className="text-gray-500">{title}</p>
      <h3 className="text-2xl font-bold text-emerald-600">{value}</h3>
    </div>
  );
}
```

âœ… **Tá»‘i Æ°u:**

* Hiá»ƒn thá»‹ dá»¯ liá»‡u tá»•ng há»£p vÃ  biá»ƒu Ä‘á»“ pháº£n biá»‡n 6 thÃ¡ng
* Recharts tÃ­ch há»£p gá»n nháº¹, tÆ°Æ¡ng thÃ­ch tá»‘t vá»›i SSR Next.js

---

## IV. ğŸ” Cáº¢I TIáº¾N Cá»¤ THá»‚ Vá»€ NGHIá»†P Vá»¤

| NhÃ³m thá»‘ng kÃª     | Má»¥c tiÃªu                           | Giáº£i phÃ¡p                                |
| ----------------- | ---------------------------------- | ---------------------------------------- |
| **Pháº£n biá»‡n**     | Theo dÃµi nÄƒng suáº¥t reviewer        | `/api/statistics/review-monthly` + chart |
| **BÃ i bÃ¡o**       | XÃ¡c Ä‘á»‹nh bÃ i Ä‘Ã£ duyá»‡t / bá»‹ tá»« chá»‘i | GroupBy `status` trong Submission        |
| **BiÃªn táº­p viÃªn** | Sá»‘ bÃ i xá»­ lÃ½ má»—i ngÆ°á»i             | `groupBy({ by: ['editorId'] })`          |
| **NgÆ°á»i dÃ¹ng**    | PhÃ¢n loáº¡i vai trÃ²                  | `groupBy({ by: ['role'] })`              |

---

## V. ğŸ§  Äá»€ XUáº¤T HOÃ€N THIá»†N TIáº¾P THEO

| Háº¡ng má»¥c            | Gá»£i Ã½ ká»¹ thuáº­t                             |
| ------------------- | ------------------------------------------ |
| BÃ¡o cÃ¡o PDF tá»± Ä‘á»™ng | DÃ¹ng `pdfkit` Ä‘á»ƒ xuáº¥t bÃ¡o cÃ¡o tá»« thá»‘ng kÃª  |
| Gá»­i email Ä‘á»‹nh ká»³   | Cron job `/api/cron/weekly-report`         |
| Dashboard Ä‘á»™ng      | DÃ¹ng WebSocket hoáº·c ISR revalidate         |
| TÃ¹y chá»n lá»c        | Bá»™ lá»c thá»i gian / ngÆ°á»i dÃ¹ng / tráº¡ng thÃ¡i |

---

## âœ… Tá»”NG Káº¾T NÃ‚NG Cáº¤P

| ThÃ nh pháº§n         | TrÆ°á»›c                 | Sau nÃ¢ng cáº¥p                     | Káº¿t quáº£            |
| ------------------ | --------------------- | -------------------------------- | ------------------ |
| API tá»•ng quan      | Cháº­m, thiáº¿u dá»¯ liá»‡u   | âœ… Chuáº©n hÃ³a + cache              | âš¡ Nhanh hÆ¡n        |
| Thá»‘ng kÃª pháº£n biá»‡n | Thiáº¿u logic thá»i gian | âœ… Theo thÃ¡ng                     | ğŸ“ˆ Äáº§y Ä‘á»§          |
| Giao diá»‡n          | PhÃ¢n tÃ¡n              | âœ… Trang tá»•ng há»£p duy nháº¥t        | ğŸ¨ Trá»±c quan       |
| Hiá»‡u nÄƒng          | Query láº·p             | âœ… Cache Redis                    | ğŸ’¨ Tá»‘i Æ°u          |
| BÃ¡o cÃ¡o            | ChÆ°a cÃ³               | âœ… ÄÃ£ cÃ³ ná»n táº£ng xuáº¥t / gá»­i mail | ğŸ“§ Má»Ÿ rá»™ng dá»… dÃ ng |

---

ğŸ“¦ **Sau khi tÃ­ch há»£p báº£n vÃ¡ nÃ y**, phÃ¢n há»‡ Thá»‘ng kÃª & BÃ¡o cÃ¡o cá»§a báº¡n sáº½ Ä‘áº¡t:

* **Äá»™ á»•n Ä‘á»‹nh:** 9.5/10
* **Kháº£ nÄƒng má»Ÿ rá»™ng:** CÃ³ thá»ƒ thÃªm dashboard nÃ¢ng cao dá»… dÃ ng
* **Hiá»‡u nÄƒng:** Truy xuáº¥t nhanh hÆ¡n gáº¥p 3â€“5 láº§n vá»›i cache