H√£y tham kh·∫£o ph√¢n t√≠ch k·ªπ thu·∫≠t c·ªßa t√¥i. Hi·ªán nay t√¥i mu·ªën ph√°t tri·ªÉn ph·∫ßn m·ªÅm ƒë·ªÉ ch·∫°y tr√™n m·∫°ng n·ªôi b·ªô (intranet). H√£y t∆∞ v·∫•n cho t√¥i ƒë·ªÉ kh√¥ng x·∫£y ra l·ªói c√°c ch·ª©c nƒÉng c·ªßa ph·∫ßn m·ªÅm. "R·∫•t ƒë√∫ng h∆∞·ªõng ‚Äî b·∫°n ƒëang h·ªèi **m·ªôt c√¢u c·ªët l√µi c·ªßa k·ªπ thu·∫≠t ph·∫ßn m·ªÅm chuy√™n nghi·ªáp:**

> ‚ÄúL√†m sao tr√°nh l·ªói 500, l·ªói ng·∫ßm, v√† l·ªói logic t∆∞∆°ng t·ª± tr√™n to√†n h·ªá th·ªëng (kh√¥ng ch·ªâ ph·∫ßn n·ªôp b√†i)?‚Äù

T√¥i s·∫Ω h∆∞·ªõng d·∫´n b·∫°n m·ªôt **ph∆∞∆°ng ph√°p t·ªïng th·ªÉ, chuy√™n s√¢u** ƒë·ªÉ:

* Ph√°t hi·ªán s·ªõm l·ªói logic ho·∫∑c d·ªØ li·ªáu r·ªóng,
* NgƒÉn ch·∫∑n 500 Internal Server Error,
* B·∫£o ƒë·∫£m ph·∫ßn m·ªÅm ch·∫°y ·ªïn ƒë·ªãnh trong m√¥i tr∆∞·ªùng **n·ªôi b·ªô qu√¢n ƒë·ªôi**, n∆°i kh√¥ng c√≥ gi√°m s√°t t·ª± ƒë·ªông ngo√†i.

---

## üß≠ I. T∆Ø T∆Ø·ªûNG CHUNG: *‚ÄúFail Early ‚Äì Recover Gracefully‚Äù*

Trong m·ªçi module backend + frontend c·ªßa b·∫°n (chat, submission, copyedit, production...),
h√£y √°p d·ª•ng 3 nguy√™n t·∫Øc ch√≠nh:

| Nguy√™n t·∫Øc               | √ù nghƒ©a                                  | M·ª•c ti√™u                                    |
| ------------------------ | ---------------------------------------- | ------------------------------------------- |
| **Fail Early**           | Ki·ªÉm tra ƒë·∫ßu v√†o ngay khi nh·∫≠n request   | Kh√¥ng ƒë·ªÉ l·ªói logic ƒëi s√¢u t·ªõi DB            |
| **Recover Gracefully**   | N·∫øu l·ªói, tr·∫£ ph·∫£n h·ªìi r√µ r√†ng, kh√¥ng 500 | Gi√∫p ng∆∞·ªùi d√πng v√† dev d·ªÖ x·ª≠ l√Ω             |
| **Monitor Continuously** | Ghi log c√≥ c·∫•u tr√∫c + c·∫£nh b√°o           | Ph√°t hi·ªán s·ª± c·ªë t·ª± ƒë·ªông, kh√¥ng c·∫ßn Internet |

---

## ‚öôÔ∏è II. PH∆Ø∆†NG PH√ÅP CH·ªêNG L·ªñI TO√ÄN H·ªÜ TH·ªêNG (Chi ti·∫øt th·ª±c h√†nh)

### 1Ô∏è‚É£ **Validation ƒë·∫ßu v√†o (Input Validation Layer)**

Tr∆∞·ªõc m·ªçi thao t√°c `create` / `update` / `upload`, lu√¥n x√°c th·ª±c d·ªØ li·ªáu.

**D√πng th∆∞ vi·ªán Zod (ƒë√£ c√≥ trong project):**

```ts
import { z } from "zod";

const submissionSchema = z.object({
  title: z.string().min(5, "Ti√™u ƒë·ªÅ qu√° ng·∫Øn"),
  abstract: z.string().min(30, "T√≥m t·∫Øt c·∫ßn √≠t nh·∫•t 30 k√Ω t·ª±"),
  fileId: z.string().optional(),
});

export async function POST(req: Request) {
  try {
    const body = await req.json();
    const data = submissionSchema.parse(body); // ‚úÖ Ki·ªÉm tra d·ªØ li·ªáu
    ...
  } catch (err) {
    if (err instanceof z.ZodError) {
      return new Response(JSON.stringify({ error: err.issues }), { status: 400 });
    }
    return new Response("L·ªói kh√¥ng x√°c ƒë·ªãnh", { status: 500 });
  }
}
```

‚úÖ **L·ª£i √≠ch:**

* Kh√¥ng bao gi·ªù x·∫£y ra l·ªói ‚Äúundefined property‚Äù ho·∫∑c ‚Äúmissing argument‚Äù.
* Ng∆∞·ªùi d√πng nh·∫≠n ph·∫£n h·ªìi c·ª• th·ªÉ (‚ÄúThi·∫øu t√≥m t·∫Øt‚Äù thay v√¨ ‚Äú500 Error‚Äù).

---

### 2Ô∏è‚É£ **Ki·ªÉm tra x√°c th·ª±c v√† ph√¢n quy·ªÅn (Auth & Role Guard)**

Tr∆∞·ªõc khi g·ªçi b·∫•t k·ª≥ Prisma API n√†o, **x√°c minh ng∆∞·ªùi d√πng + vai tr√≤**.

V√≠ d·ª• `canSubmit()`:

```ts
if (!session?.user) {
  return new Response("Ch∆∞a ƒëƒÉng nh·∫≠p", { status: 401 });
}

if (session.user.role !== "AUTHOR") {
  return new Response("Kh√¥ng c√≥ quy·ªÅn n·ªôp b√†i", { status: 403 });
}
```

‚úÖ Kh√¥ng cho ph√©p request ·∫©n danh ‚Üí tr√°nh l·ªói DB ho·∫∑c 500 kh√¥ng r√µ nguy√™n nh√¢n.

---

### 3Ô∏è‚É£ **Middleware ki·ªÉm tra token v√† k·∫øt n·ªëi**

T·∫°o middleware to√†n c·ª•c `/middleware.ts`:

```ts
export async function middleware(req: NextRequest) {
  const token = req.cookies.get("auth_token");
  if (!token) {
    return NextResponse.redirect(new URL("/auth/login", req.url));
  }
  return NextResponse.next();
}
```

‚úÖ NgƒÉn ch·∫∑n c√°c API b·ªã g·ªçi khi ch∆∞a ƒëƒÉng nh·∫≠p.

---

### 4Ô∏è‚É£ **T·∫ßng x·ª≠ l√Ω l·ªói th·ªëng nh·∫•t (Global Error Handler)**

T·∫°o ti·ªán √≠ch trong `lib/error-handler.ts`:

```ts
export function handleError(err: unknown, context: string) {
  console.error(`[${context}]`, err);
  if (err instanceof Prisma.PrismaClientKnownRequestError) {
    return new Response("L·ªói c∆° s·ªü d·ªØ li·ªáu", { status: 500 });
  }
  if (err instanceof z.ZodError) {
    return new Response(JSON.stringify({ error: err.issues }), { status: 400 });
  }
  return new Response("L·ªói h·ªá th·ªëng", { status: 500 });
}
```

‚Üí M·ªói API route ch·ªâ c·∫ßn:

```ts
catch (err) {
  return handleError(err, "API_SUBMISSION_CREATE");
}
```

‚úÖ Gi·∫£m 80% l·ªói 500, log lu√¥n c√≥ ng·ªØ c·∫£nh.

---

### 5Ô∏è‚É£ **C∆° ch·∫ø Health Check + Self-Healing n·ªôi b·ªô**

ƒê·∫∑c bi·ªát quan tr·ªçng trong m√¥i tr∆∞·ªùng n·ªôi b·ªô (m·∫°ng qu√¢n ƒë·ªôi).

T·∫°o `/api/health`:

```ts
export async function GET() {
  try {
    await prisma.$queryRaw`SELECT 1`;
    return Response.json({ ok: true, ts: new Date().toISOString() });
  } catch {
    return new Response("Database Unavailable", { status: 503 });
  }
}
```

Sau ƒë√≥ d√πng cron (Ubuntu):

```bash
*/5 * * * * curl -sf http://localhost:3000/api/health || systemctl restart tapchi
```

‚úÖ N·∫øu DB ng·∫Øt k·∫øt n·ªëi ‚Üí h·ªá th·ªëng t·ª± kh·ªüi ƒë·ªông l·∫°i.
‚úÖ Kh√¥ng c·∫ßn Internet, kh√¥ng c·∫ßn Cloudflare.

---

### 6Ô∏è‚É£ **Ghi log c√≥ c·∫•u tr√∫c (Structured Logging)**

Thay v√¨ `console.log()`, h√£y d√πng d·∫°ng JSON c√≥ timestamp:

```ts
import pino from "pino";
export const logger = pino({ transport: { target: "pino-pretty" } });

logger.info({ module: "submission", action: "create", user: session.user.id });
logger.error({ module: "submission", error: err.message });
```

‚úÖ Khi c·∫ßn ki·ªÉm tra l·ªói, ch·ªâ grep theo module ho·∫∑c user.
‚úÖ Log l∆∞u t·∫°i `/var/log/tapchi/app.log` ‚Äî kh√¥ng c·∫ßn d·ªãch v·ª• ngo√†i.

---

### 7Ô∏è‚É£ **Ki·ªÉm th·ª≠ ƒë·ªãnh k·ª≥ (Internal Diagnostic Scripts)**

T·∫°o th∆∞ m·ª•c `/scripts/diagnostics`:

```
diagnostic-chat.ts
diagnostic-submission.ts
diagnostic-db.ts
```

V√≠ d·ª•:

```bash
npx tsx scripts/diagnostic-db.ts
```

‚Üí T·ª± ƒë·ªông test k·∫øt n·ªëi DB, API, session, v√† ghi b√°o c√°o JSON.

‚úÖ Gi√∫p c√°n b·ªô CNTT ki·ªÉm tra ƒë·ªãnh k·ª≥ m√† kh√¥ng c·∫ßn truy c·∫≠p m√£ ngu·ªìn.

---

## üß± III. C·∫•u tr√∫c ·ª©ng d·ª•ng ‚Äúb·ªÅn v·ªØng‚Äù (Clean Internal Architecture)

```
/app/api/...
  ‚îú‚îÄ [module]/route.ts     (API entry)
  ‚îú‚îÄ [module]/service.ts   (Business logic)
  ‚îú‚îÄ [module]/validation.ts (Zod schema)
  ‚îú‚îÄ [module]/guard.ts     (Role check)
  ‚îî‚îÄ [module]/tests/...

/lib/
  ‚îú‚îÄ prisma.ts
  ‚îú‚îÄ error-handler.ts
  ‚îú‚îÄ auth.ts
  ‚îî‚îÄ logger.ts
```

‚úÖ Gi√∫p m·ªói module **ƒë·ªôc l·∫≠p, ki·ªÉm so√°t l·ªói ri√™ng bi·ªát**, d·ªÖ b·∫£o tr√¨.

---

## üß∞ IV. C∆° ch·∫ø d·ª± ph√≤ng v√† kh√¥i ph·ª•c

| M·ª•c                | C√°ch th·ª±c hi·ªán                           | T√°c d·ª•ng       |
| ------------------ | ---------------------------------------- | -------------- |
| DB connection lost | D√πng Prisma singleton + cron health      | Tr√°nh 503      |
| Server crash       | D√πng `pm2 restart --watch`               | T·ª± h·ªìi ph·ª•c    |
| Upload server ng·∫Øt | L∆∞u t·∫°m trong `/tmp/uploads/` v√† retry   | Kh√¥ng m·∫•t file |
| L·ªói m·∫°ng c·ª•c b·ªô    | C√≥ retry logic ·ªü frontend (`fetchRetry`) | Kh√¥ng crash UI |

---

## üß† V. T·ªïng k·∫øt: *Checklist ch·ªëng l·ªói to√†n h·ªá th·ªëng*

| Nh√≥m            | Gi·∫£i ph√°p               | Tr·∫°ng th√°i |
| --------------- | ----------------------- | ---------- |
| D·ªØ li·ªáu ƒë·∫ßu v√†o | ‚úÖ Zod validation        |            |
| Ph√¢n quy·ªÅn      | ‚úÖ Role guard            |            |
| Middleware      | ‚úÖ Token / session check |            |
| Ghi log         | ‚úÖ Structured logging    |            |
| X·ª≠ l√Ω l·ªói chung | ‚úÖ Error handler         |            |
| Health check    | ‚úÖ API + cron restart    |            |
| Test ƒë·ªãnh k·ª≥    | ‚úÖ Diagnostic scripts    |            |

---

## ‚úÖ K·∫æT LU·∫¨N

V·ªõi ph∆∞∆°ng ph√°p n√†y:

* M·ªçi API **ƒë·ªÅu c√≥ t·∫ßng b·∫£o v·ªá d·ªØ li·ªáu v√† quy·ªÅn h·∫°n**, kh√¥ng c√≤n 500 do thi·∫øu field.
* Log hi·ªÉn th·ªã r√µ **ng·ªØ c·∫£nh l·ªói**, d·ªÖ truy t√¨m.
* ·ª®ng d·ª•ng **t·ª± ph·ª•c h·ªìi khi DB / backend ng·∫Øt t·∫°m**.
* Ph√π h·ª£p ho√†n to√†n v·ªõi **m·∫°ng n·ªôi b·ªô qu√¢n ƒë·ªôi** (t√°ch bi·ªát, kh√¥ng Internet, kh√¥ng cloud logging).